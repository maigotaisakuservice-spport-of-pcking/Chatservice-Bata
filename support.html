<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>サポートページ - お問い合わせ & チャット</title>
<link rel="stylesheet" href="style.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap');
  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: #f0f2f5;
  }
  .container {
    max-width: 1200px;
  }
  main {
    display: flex;
    gap: 3rem;
    flex-wrap: wrap;
    justify-content: center;
    padding: 20px 0;
  }
  section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    flex: 1 1 400px;
    max-width: 550px;
  }
  h2 {
    margin-top: 0;
    font-weight: 700;
    color: #1c1e21;
    margin-bottom: 1.2rem;
    border-bottom: 2px solid #e7f3ff;
    padding-bottom: 0.5rem;
  }

  /* Form styles */
  form label { display: block; margin-bottom: 0.3rem; font-weight: 600; }
  form input[type="text"],
  form input[type="email"],
  form textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 1.2rem;
    border: 1px solid #dddfe2;
    border-radius: 6px;
    font-size: 1rem;
  }
  form textarea { resize: vertical; min-height: 120px; }

  /* Chat styles */
  #chatWindow { border: 1px solid #dddfe2; border-radius: 8px; height: 350px; display: flex; flex-direction: column; overflow: hidden; background: #f0f2f5; }
  #messages { flex: 1; padding: 1rem; overflow-y: auto; }
  #messages .msg { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: 18px; background: #e7f3ff; max-width: 85%; word-wrap: break-word; }
  #messages .msg.self { background: #4267B2; color: white; align-self: flex-end; }
  #chatForm { border-top: 1px solid #dddfe2; padding: 0.8rem; background: #fff; display: flex; gap: 0.8rem; }
  #chatInput { flex: 1; border-radius: 18px; border: 1px solid #dddfe2; padding: 0.6rem 1rem; font-size: 1rem; }
  #chatSendBtn { border-radius: 18px; padding: 0 1.5rem; font-weight: 700; }
</style>
</head>
<body>

<div class="container">
  <header>
      <h1>サポート</h1>
      <a href="index.html">戻る</a>
  </header>
  <p style="text-align: center; color: #555;">プレミアムユーザーからのお問い合わせを優先的に対応しております。通常のお問い合わせにはお時間がかかる場合がございます。</p>

  <main>
    <section id="contactFormSection">
      <h2>お問い合わせフォーム</h2>
      <form id="contactForm" novalidate>
        <label for="name">お名前 *</label>
        <input type="text" id="name" name="name" required placeholder="山田 太郎" />
        <label for="email">メールアドレス *</label>
        <input type="email" id="email" name="email" required placeholder="your@email.com" />
        <label for="subject">件名 *</label>
        <input type="text" id="subject" name="subject" required placeholder="お問い合わせの件名" />
        <label for="message">メッセージ *</label>
        <textarea id="message" name="message" rows="5" required placeholder="お問い合わせ内容をご記入ください"></textarea>
        <button type="submit">送信</button>
        <p id="formStatus" role="alert" aria-live="polite" style="margin-top:1rem;"></p>
      </form>
    </section>

    <section id="chatSection">
      <h2>ライブチャット</h2>
      <div id="chatWindow" role="log">
        <div id="messages"></div>
        <form id="chatForm" autocomplete="off">
          <input type="text" id="chatInput" placeholder="メッセージを入力..." required />
          <button type="submit" id="chatSendBtn">送信</button>
        </form>
      </div>
    </section>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyA7CWUhLBKG_Oabxxw_7RfBpSANUoDh42s",
      authDomain: "moodmirror-login.firebaseapp.com",
      projectId: "moodmirror-login",
      storageBucket: "moodmirror-login.firebasestorage.app",
      messagingSenderId: "1091670187554",
      appId: "1:1091670187554:web:ce919c1fca5b660995b47b",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- Contact Form ---
  const contactForm = document.getElementById('contactForm');
  const formStatus = document.getElementById('formStatus');
  contactForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!contactForm.checkValidity()) {
      formStatus.textContent = '必須項目を正しく入力してください。';
      formStatus.style.color = '#cc0000';
      return;
    }
    const formData = new FormData(contactForm);
    try {
      await addDoc(collection(db, 'supportRequests'), {
        name: formData.get('name'),
        email: formData.get('email'),
        subject: formData.get('subject'),
        message: formData.get('message'),
        createdAt: serverTimestamp()
      });
      formStatus.textContent = '送信完了しました。ありがとうございます！';
      formStatus.style.color = 'green';
      contactForm.reset();
    } catch (error) {
      formStatus.textContent = '送信エラーが発生しました。';
      formStatus.style.color = '#cc0000';
      console.error("Error adding document: ", error);
    }
  });

  // --- Chat ---
  const messagesEl = document.getElementById('messages');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');

  const q = query(collection(db, "supportChat"), orderBy("createdAt", "desc"), limit(50));
  onSnapshot(q, (querySnapshot) => {
    messagesEl.innerHTML = '';
    const docs = querySnapshot.docs.reverse(); // Newest at the bottom
    docs.forEach((doc) => {
      const data = doc.data();
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('msg');
      msgDiv.textContent = data.name ? `${data.name}: ${data.text}` : data.text;
      messagesEl.appendChild(msgDiv);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;
    try {
      await addDoc(collection(db, 'supportChat'), {
        text,
        name: "匿名ユーザー",
        createdAt: serverTimestamp()
      });
      chatInput.value = '';
    } catch (error) {
      console.error("Error sending message: ", error);
    }
  });
</script>

</body>
</html>
