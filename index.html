<script type="module">
    import { auth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "./app.js";
    import { RecaptchaVerifier, PhoneAuthProvider, getMultiFactorResolver, PhoneMultiFactorGenerator } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const loginForm = document.getElementById('loginForm');
    const emailPasswordSection = document.getElementById('email-password-section');
    const mfaContainer = document.getElementById('mfa-container');
    const googleLoginBtn = document.getElementById('googleLogin');

    // Initialize reCAPTCHA
    const recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
      'size': 'invisible'
    });

    // Handle standard email/password and MFA login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const submitButton = loginForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            sessionStorage.setItem('userId', userCredential.user.uid);
            window.location.href = 'chat.html';
        } catch (error) {
            if (error.code === 'auth/multi-factor-auth-required') {
                const resolver = getMultiFactorResolver(auth, error);
                const phoneInfo = resolver.hints.find(info => info.factorId === PhoneMultiFactorGenerator.FACTOR_ID);
                if (!phoneInfo) {
                    return alert("電話による2段階認証が設定されていません。");
                }

                const phoneAuthProvider = new PhoneAuthProvider(auth);
                try {
                    const verificationId = await phoneAuthProvider.verifyPhoneNumber(
                        { multiFactorHint: phoneInfo, session: resolver.session },
                        recaptchaVerifier
                    );

                    emailPasswordSection.style.display = 'none';
                    googleLoginBtn.style.display = 'none'; // Hide Google button during MFA
                    mfaContainer.style.display = 'block';

                    document.getElementById('mfa-submit').onclick = async () => {
                        const verificationCode = document.getElementById('mfa-code').value;
                        const cred = PhoneAuthProvider.credential(verificationId, verificationCode);
                        const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);

                        try {
                            const userCredential = await resolver.resolveSignIn(multiFactorAssertion);
                            sessionStorage.setItem('userId', userCredential.user.uid);
                            window.location.href = 'chat.html';
                        } catch (err) {
                            alert('MFAコードが無効です: ' + err.message);
                        }
                    };
                } catch (err) {
                    alert('SMSの送信に失敗しました: ' + err.message);
                    recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                }
            } else {
                alert("ログインに失敗しました: " + error.message);
            }
        } finally {
            submitButton.disabled = false;
        }
    });

    // Handle Google Login
    googleLoginBtn.addEventListener('click', async () => {
        const provider = new GoogleAuthProvider();
        try {
            const result = await signInWithPopup(auth, provider);
            sessionStorage.setItem('userId', result.user.uid);
            window.location.href = 'chat.html';
        } catch (error) {
            alert("Googleログインに失敗しました: " + error.message);
        }
    });
</script>
