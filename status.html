<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中央データセンター稼働状況</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background: #eef3f9;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    #data-center {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      padding: 2rem 0;
    }
    .rack {
      background: linear-gradient(145deg, #dbe7f5, #ffffff);
      border-radius: 20px;
      box-shadow: 8px 8px 25px rgba(0,0,0,0.1), -8px -8px 25px rgba(255,255,255,0.9);
      padding: 1.5rem;
      transition: transform 0.3s ease;
    }
    .rack:hover {
      transform: translateY(-5px);
    }
    .rack h3 {
      text-align: center;
      margin-bottom: 1rem;
      color: #333;
      font-size: 1.2rem;
    }
    .server {
      background: #222;
      border-radius: 12px;
      margin: 10px 0;
      padding: 0.8rem;
      color: white;
      font-size: 0.9rem;
      position: relative;
      cursor: pointer;
      box-shadow: inset 0 0 8px rgba(255,255,255,0.1);
      border: 1px solid #444;
    }
    .led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: limegreen;
      box-shadow: 0 0 8px limegreen, 0 0 12px limegreen inset;
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    .server.off .led { background: #555; box-shadow: none; }
    .server.warning .led { background: red; box-shadow: 0 0 8px red, 0 0 12px red inset; }
    .bar-container, .temp-container { margin-top: 8px; background: #444; border-radius: 8px; overflow: hidden; height: 10px; }
    .bar { height: 100%; background: #007bff; width: 0%; }
    .temp { height: 100%; width: 0%; }
    #warning-message {
      display: none;
      text-align: center;
      background: #ffcdd2;
      color: #c62828;
      padding: 15px;
      font-weight: bold;
      border-radius: 10px;
      border: 1px solid #ef9a9a;
      margin-bottom: 20px;
    }
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
    #modal-content { background: white; border-radius: 12px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header>
      <h1>中央データセンター稼働状況</h1>
      <a href="index.html">ログインページへ</a>
    </header>
    <div id="warning-message">⚠️ 高負荷サーバーが検出されました</div>
    <div id="data-center"></div>
  </div>

  <div id="modal">
    <div id="modal-content">
      <div id="modal-details"></div>
      <button id="modal-close">閉じる</button>
    </div>
  </div>

  <audio id="working-sound" loop src="https://cdn.pixabay.com/audio/2022/10/12/audio_1f19e79b5d.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // The JavaScript logic remains the same
    const cpuHistory = {};
    const workingSound = document.getElementById("working-sound");
    async function fetchStatus() {
      try {
        const res = await fetch("status/status.json");
        if (!res.ok) throw new Error("Status file not found");
        return await res.json();
      } catch (error) {
        console.error("Could not fetch status:", error);
        return {}; // Return empty data to prevent script from crashing
      }
    }
    function getTempColor(temp) {
      if (temp < 60) return "linear-gradient(90deg, #28a745, #218838)";
      if (temp < 75) return "linear-gradient(90deg, #ffc107, #e0a800)";
      return "linear-gradient(90deg, #dc3545, #c82333)";
    }
    function createServerElement(server) {
      const div = document.createElement("div");
      div.className = "server";
      if (server.status === "OFF") div.classList.add("off");
      const cpu = parseFloat(server.cpu) || 0;
      const temp = parseFloat(server.temp) || 32;
      if (server.status === "ON" && cpu > 85) {
        div.classList.add("warning");
      }
      div.innerHTML = `
        <span class="led"></span> ${server.name}
        <div class="bar-container" title="CPU: ${cpu}%"><div class="bar" style="width:${cpu}%;"></div></div>
        <div class="temp-container" title="Temp: ${temp}°C"><div class="temp" style="width:${temp}%; background:${getTempColor(temp)};"></div></div>
      `;
      div.addEventListener("click", () => {
        const modal = document.getElementById("modal");
        const content = document.getElementById("modal-details");
        const hist = cpuHistory[server.name] || [];
        content.innerHTML = `
          <h3>${server.name}</h3>
          <p>CPU使用率: ${cpu}%</p>
          <p>温度: ${temp}℃</p>
          <p>状態: ${server.status}</p>
          <h4>最近のCPU履歴</h4>
          <ul style="padding-left: 20px;">${hist.slice(-5).map(v => `<li>${v}%</li>`).join('') || '<li>データなし</li>'}</ul>
        `;
        modal.style.display = "flex";
      });
      cpuHistory[server.name] = (cpuHistory[server.name] || []).concat(cpu).slice(-20);
      return { div, warning: cpu > 85 && server.status === "ON", cpu, status: server.status };
    }
    async function renderDataCenter() {
      const data = await fetchStatus();
      if (Object.keys(data).length === 0) return;
      const container = document.getElementById("data-center");
      const warningMsg = document.getElementById("warning-message");
      container.innerHTML = "";
      let warningExists = false;
      let anyServerOn = false;
      for (const [rackName, servers] of Object.entries(data)) {
        const rackDiv = document.createElement("div");
        rackDiv.className = "rack";
        rackDiv.innerHTML = `<h3>${rackName}</h3>`;
        let cpuSum = 0, activeCount = 0;
        servers.forEach(server => {
          const { div, warning, cpu, status } = createServerElement(server);
          if (warning) warningExists = true;
          if (status === "ON") {
            cpuSum += cpu;
            activeCount++;
            anyServerOn = true;
          }
          rackDiv.appendChild(div);
        });
        container.appendChild(rackDiv);
      }
      warningMsg.style.display = warningExists ? "block" : "none";
      if (anyServerOn && workingSound.paused) workingSound.play().catch(e=>console.warn("Autoplay blocked"));
      else if (!anyServerOn) workingSound.pause();
    }
    document.getElementById("modal-close").onclick = () => {
      document.getElementById("modal").style.display = "none";
    };
    renderDataCenter();
    setInterval(renderDataCenter, 10000);
  </script>
</body>
</html>
