<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ChatGo - 新規登録</title>
  <style>
    body {
        font-family: 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
    }
    .container {
        background: rgba(255, 255, 255, 0.1);
        padding: 2em 3em;
        border-radius: 1.5em;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(8.5px);
        -webkit-backdrop-filter: blur(8.5px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        text-align: center;
        width: 400px;
    }
    h2 {
        font-size: 2em;
        margin-bottom: 1em;
    }
    input {
        display: block;
        margin-bottom: 1.5em;
        padding: 0.8em;
        width: 100%;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 0.8em;
        color: #fff;
    }
    button {
        padding: 0.8em;
        background-color: #8e44ad;
        color: white;
        border: none;
        border-radius: 0.8em;
        cursor: pointer;
        width: 100%;
        margin-bottom: 1em;
    }
    .google-btn {
        background-color: #c0392b;
    }
    #recaptcha-container {
        margin-bottom: 1em;
    }
    .hidden {
        display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>ChatGo 新規登録</h2>
  <a href="index.html" style="color:white; display:block; margin-bottom:1em;">ログイン画面へ戻る</a>

  <div id="email-password-section">
      <input type="email" id="email" placeholder="メールアドレス" required>
      <input type="password" id="password" placeholder="パスワード" required>
      <button type="button" id="continue-btn">次へ</button>
  </div>

  <div id="phone-section" class="hidden">
      <input type="tel" id="phone" placeholder="電話番号 (例: +819012345678)" required>
      <div id="recaptcha-container"></div>
      <button type="button" id="send-sms-btn">SMS認証コードを送信</button>
  </div>

  <div id="sms-code-section" class="hidden">
      <input type="text" id="sms-code" placeholder="SMS認証コード" required>
      <button type="button" id="finish-btn">登録完了</button>
  </div>

  <button class="google-btn" id="googleSignUp">Googleで登録</button>
  <a href="terms-of-service.html"><p>利用規約 (必ずお読みください)</p></a>
</div>

<script type="module">
    import { auth, db, ref, set, GoogleAuthProvider, signInWithPopup } from './app.js';
    import { createUserWithEmailAndPassword, RecaptchaVerifier, PhoneAuthProvider, multiFactor, PhoneMultiFactorGenerator } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    let userCredential, multiFactorSession, verificationId;

    const emailPasswordSection = document.getElementById('email-password-section');
    const phoneSection = document.getElementById('phone-section');
    const smsCodeSection = document.getElementById('sms-code-section');

    // 1. Continue after email/password input
    document.getElementById('continue-btn').addEventListener('click', () => {
        emailPasswordSection.classList.add('hidden');
        phoneSection.classList.remove('hidden');
    });

    // Setup reCAPTCHA
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });

    // 2. Send SMS after phone number input
    document.getElementById('send-sms-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const phoneNumber = document.getElementById('phone').value;

        try {
            // Create user first
            userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Get MFA session
            multiFactorSession = await multiFactor(user).getSession();

            const phoneInfoOptions = { phoneNumber: phoneNumber, session: multiFactorSession };
            const phoneAuthProvider = new PhoneAuthProvider(auth);

            verificationId = await phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, window.recaptchaVerifier);

            alert('SMS認証コードを送信しました。');
            phoneSection.classList.add('hidden');
            smsCodeSection.classList.remove('hidden');

        } catch (error) {
            console.error("登録またはSMS送信エラー:", error);
            alert("エラーが発生しました: " + error.message);
            // Reset UI if needed
            emailPasswordSection.classList.remove('hidden');
            phoneSection.classList.add('hidden');
        }
    });

    // 3. Finish registration with SMS code
    document.getElementById('finish-btn').addEventListener('click', async () => {
        const code = document.getElementById('sms-code').value;
        try {
            const cred = PhoneAuthProvider.credential(verificationId, code);
            const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);

            // Enroll the second factor
            await multiFactor(userCredential.user).enroll(multiFactorAssertion);

            // Save user info to DB
            await set(ref(db, 'users/' + userCredential.user.uid), {
                email: userCredential.user.email,
                phoneNumber: document.getElementById('phone').value,
                createdAt: new Date().toISOString()
            });

            alert("登録完了！チャット画面に移動します。");
            window.location.href = "chat.html";

        } catch (error) {
            console.error("MFA登録エラー:", error);
            alert("認証コードが無効か、登録に失敗しました: " + error.message);
        }
    });

    // Google Sign-Up (MFA enrollment would need to be a separate step for these users)
    document.getElementById('googleSignUp').addEventListener('click', async () => {
        // ... (Google sign-up logic remains, but be aware MFA is not enforced here)
    });
</script>

</body>
</html>
