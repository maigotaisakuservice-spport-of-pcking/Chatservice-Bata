<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ChatGo - 新規登録</title>
  <style>
    /* ... existing styles ... */
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2>ChatGo 新規登録</h2>
  <a href="index.html" style="color:white; display:block; margin-bottom:1em;">ログイン画面へ戻る</a>

  <form id="registerForm">
      <div id="email-password-section">
          <input type="email" id="email" placeholder="メールアドレス" required>
          <input type="password" id="password" placeholder="パスワード" required>
          <button type="button" id="continue-btn">次へ</button>
      </div>

      <div id="phone-section" class="hidden">
          <input type="tel" id="phone" placeholder="電話番号 (例: +819012345678)" required>
          <div id="recaptcha-container"></div>
          <button type="button" id="send-sms-btn">SMS認証コードを送信</button>
      </div>

      <div id="sms-code-section" class="hidden">
          <input type="text" id="sms-code" placeholder="SMS認証コード" required>
          <button type="submit" id="finish-btn">登録完了</button>
      </div>
  </form>

  <button class="google-btn" id="googleSignUp">Googleで登録</button>
  <a href="terms-of-service.html"><p>利用規約 (必ずお読みください)</p></a>
</div>

<script type="module">
    import { auth, db } from './app.js';
    import { createUserWithEmailAndPassword, RecaptchaVerifier, PhoneAuthProvider, multiFactor, PhoneMultiFactorGenerator, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    let userCredential, verificationId;

    const emailPasswordSection = document.getElementById('email-password-section');
    const phoneSection = document.getElementById('phone-section');
    const smsCodeSection = document.getElementById('sms-code-section');
    const continueBtn = document.getElementById('continue-btn');
    const sendSmsBtn = document.getElementById('send-sms-btn');
    const registerForm = document.getElementById('registerForm');

    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });

    continueBtn.addEventListener('click', () => {
        emailPasswordSection.style.display = 'none';
        phoneSection.classList.remove('hidden');
    });

    sendSmsBtn.addEventListener('click', async () => {
        const phoneNumber = document.getElementById('phone').value;
        try {
            const phoneAuthProvider = new PhoneAuthProvider(auth);
            verificationId = await phoneAuthProvider.verifyPhoneNumber(phoneNumber, window.recaptchaVerifier);
            phoneSection.classList.add('hidden');
            smsCodeSection.classList.remove('hidden');
            alert('SMSを送信しました。');
        } catch (error) {
            alert('SMS送信エラー: ' + error.message);
        }
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const code = document.getElementById('sms-code').value;

        try {
            userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const { user } = userCredential;

            const cred = PhoneAuthProvider.credential(verificationId, code);
            const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);
            await multiFactor(user).enroll(multiFactorAssertion, `PhoneNumber`);

            await setDoc(doc(db, "users", user.uid), {
                email: user.email,
                phoneNumber: document.getElementById('phone').value,
                createdAt: new Date().toISOString()
            });

            window.location.href = "chat.html";
        } catch (error) {
            alert('登録エラー: ' + error.message);
        }
    });
</script>

</body>
</html>
