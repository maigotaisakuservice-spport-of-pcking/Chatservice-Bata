<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ChatGo - チャット</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: white;
      color: black;
      transition: all 0.3s;
    }
    .dark {
      background-color: #121212;
      color: white;
    }
    header {
      background-color: #4CAF50;
      color: white;
      padding: 1em;
      text-align: center;
    }
    #messages {
      height: 70vh;
      overflow-y: scroll;
      padding: 1em;
      border-bottom: 1px solid #ccc;
    }
    .message {
      margin: 0.5em 0;
      padding: 0.5em;
      border-radius: 0.5em;
      background: #e0ffe0;
    }
    .own {
      background: #d1f7ff;
    }
    #form {
      display: flex;
      padding: 1em;
    }
    #form input {
      flex: 1;
      padding: 0.5em;
    }
    #form button {
      padding: 0.5em 1em;
      background: #4CAF50;
      color: white;
      border: none;
    }
    #toggleMode {
      position: absolute;
      right: 1em;
      top: 1em;
    }
  </style>
</head>
<body>
  <header>
    ChatGo - チャット
    <a href="profile.html">プロフィールページへ</a>
    <button id="toggleMode">切替</button>
  </header>

  <div id="messages"></div>

  <form id="form">
    <input type="text" id="textInput" placeholder="メッセージを入力" required>
    <button type="submit">送信</button>
  </form>

  <script type="module">
    import {
      auth,
      db,
      ref,
      push,
      onChildAdded,
      get,
      child
    } from './app.js';

    const user = auth.currentUser;
    if (!user) window.location.href = 'login.html';

    const messagesRef = ref(db, 'messages/');
    const form = document.getElementById('form');
    const input = document.getElementById('textInput');
    const messagesDiv = document.getElementById('messages');
    const toggleMode = document.getElementById('toggleMode');

    let currentMode = sessionStorage.getItem('mode') || 'light';
    if (currentMode === 'dark') document.body.classList.add('dark');

    toggleMode.addEventListener('click', () => {
      currentMode = (currentMode === 'light') ? 'dark' : 'light';
      sessionStorage.setItem('mode', currentMode);
      document.body.classList.toggle('dark');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value;
      input.value = '';
      await push(messagesRef, {
        uid: auth.currentUser.uid,
        text,
        timestamp: Date.now()
      });
    });

    onChildAdded(messagesRef, async (data) => {
      const msg = data.val();
      const uid = msg.uid;
      const userSnap = await get(child(ref(db), `users/${uid}`));
      const userName = userSnap.exists() ? userSnap.val().email : '匿名';

      const div = document.createElement('div');
      div.className = 'message' + (uid === auth.currentUser.uid ? ' own' : '');
      div.textContent = `${userName}：${msg.text}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // セッションストレージにも保存
      const existing = JSON.parse(sessionStorage.getItem('chatlog') || '[]');
      existing.push({ uid, text: msg.text });
      sessionStorage.setItem('chatlog', JSON.stringify(existing));
    });
  </script>
</body>
</html>
