<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー通報ページ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* 入力フォームのスタイル */
        .form-label {
            @apply block text-sm font-medium text-gray-400 mb-2; /* マージンを増やして見やすく調整 */
        }
        /* 入力ボックス、セレクトボックス、表示用テキストの共通スタイル */
        .form-input, .form-display {
            @apply block w-full px-3 py-2 bg-black border border-gray-600 rounded-md shadow-sm text-white placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm transition-colors;
        }
        /* フォーカス時の背景色変更を無効化 */
        .form-input:focus {
            @apply bg-black;
        }
        .form-input:disabled, .form-select:disabled {
            @apply bg-gray-800 text-gray-500 cursor-not-allowed border-gray-700;
        }
        /* IPアドレス表示用のスタイル */
        .form-display {
             @apply cursor-default select-none; /* コピーできないようにする */
        }
        .form-checkbox {
            @apply h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500;
        }
        /* 送信ボタンのスタイル */
        .submit-button {
            @apply w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-red-500 transition-opacity;
        }
        .submit-button:disabled {
            @apply bg-red-900/50 text-gray-400 cursor-not-allowed;
        }
        /* 確認モーダルのボタンのスタイル */
        .modal-button {
             @apply px-4 py-2 text-base font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800;
        }
        .modal-confirm-button {
            @apply modal-button bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        .modal-cancel-button {
            @apply modal-button bg-gray-600 text-gray-200 hover:bg-gray-500 focus:ring-gray-400 ml-3;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-gray-800 p-8 rounded-xl border border-red-700/50 shadow-lg shadow-red-900/20">
            <div class="text-center">
                 <svg class="mx-auto h-12 w-12 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <h2 class="mt-4 text-center text-3xl font-extrabold text-red-500">
                    警告：ユーザー報告
                </h2>
                <p class="mt-2 text-center text-sm text-gray-400">
                    虚偽の報告は利用規約違反となります。内容をよくご確認の上、送信してください。
                </p>
            </div>
            <form id="reportForm" class="mt-8 space-y-6">
                <fieldset id="reportFieldset" disabled>
                    <div class="space-y-4">
                        <div>
                            <label for="reporterEmail" class="form-label">報告者のメールアドレス</label>
                            <input id="reporterEmail" name="reporterEmail" type="email" autocomplete="email" required class="form-input" placeholder="you@example.com">
                        </div>
                        <div>
                            <label for="reportedUserEmail" class="form-label">通報するユーザーのメールアドレス</label>
                            <input id="reportedUserEmail" name="reportedUserEmail" type="email" required class="form-input" placeholder="offender@example.com">
                        </div>
                        <div>
                            <label for="category" class="form-label">通報カテゴリ</label>
                            <input id="category" name="category" type="text" required class="form-input" placeholder="例: スパム・迷惑行為、不適切なコンテンツ">
                        </div>
                        <div>
                            <label for="reason" class="form-label">通報理由</label>
                            <textarea id="reason" name="reason" rows="4" required class="form-input" placeholder="できるだけ詳しく状況を説明してください。"></textarea>
                        </div>
                        <div>
                            <label for="screenshotLink" class="form-label">証拠のリンク (任意)</label>
                            <p class="text-xs text-gray-500 mb-1">スクリーンショット等をGoogle Drive等にアップロードし、共有リンクを貼り付けてください。</p>
                            <input id="screenshotLink" name="screenshotLink" type="url" class="form-input" placeholder="https://drive.google.com/...">
                        </div>
                        <!-- IPアドレスをテキストとして表示する部分 -->
                        <div>
                            <label class="form-label">あなたのIPアドレス</label>
                            <div id="ipAddressDisplay" class="form-display text-gray-400">取得中...</div>
                            <input type="hidden" id="ipAddress" name="ipAddress" value="">
                        </div>
                    </div>
                </fieldset>

                <div class="pt-4">
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="agreement" name="agreement" type="checkbox" class="form-checkbox" disabled>
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="agreement" class="font-medium text-gray-400">同意事項</label>
                            <p class="text-gray-500">この報告に虚偽の内容が含まれておらず、虚偽の報告を行った場合、アカウントが停止される可能性があることを理解しました。</p>
                        </div>
                    </div>
                </div>

                <div>
                    <button type="submit" id="submitButton" class="group relative submit-button" disabled>
                        <span id="submitButtonText">初期化中...</span>
                    </button>
                </div>
            </form>
            <div id="statusMessage" class="text-center text-sm text-gray-400 min-h-[20px]"></div>
        </div>
    </div>

    <!-- 確認モーダル -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-80 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border border-red-700/50 w-full max-w-sm shadow-lg rounded-md bg-gray-800">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-red-500">最終確認</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-300">
                        この内容で通報します。送信後は取り消せません。
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmReportButton" class="modal-confirm-button w-auto">
                        はい、通報する
                    </button>
                    <button id="cancelReportButton" class="modal-cancel-button w-auto">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase モジュールのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        // --- グローバル変数 ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7CWUhLBKG_Oabxxw_7RfBpSANUoDh42s",
            authDomain: "moodmirror-login.firebaseapp.com",
            databaseURL: "https://moodmirror-login-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "moodmirror-login",
            storageBucket: "moodmirror-login.firebasestorage.app",
            messagingSenderId: "1091670187554",
            appId: "1:1091670187554:web:ce919c1fca5b660995b47b",
            measurementId: "G-TPJXPMPSGZ"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let isInitialized = false;

        // --- DOM要素 ---
        const reportForm = document.getElementById('reportForm');
        const reportFieldset = document.getElementById('reportFieldset');
        const agreementCheckbox = document.getElementById('agreement');
        const submitButton = document.getElementById('submitButton');
        const submitButtonText = document.getElementById('submitButtonText');
        const statusMessage = document.getElementById('statusMessage');
        const ipAddressDisplay = document.getElementById('ipAddressDisplay'); // IP表示用の新しい要素
        const ipAddressHiddenInput = document.getElementById('ipAddress'); // IP送信用の隠し要素
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmReportButton = document.getElementById('confirmReportButton');
        const cancelReportButton = document.getElementById('cancelReportButton');

        // --- 機能関数 ---
        
        const updateSubmitButtonState = () => {
            if (isInitialized && agreementCheckbox.checked) {
                submitButton.disabled = false;
                submitButtonText.textContent = '通報内容を確認する';
            } else {
                submitButton.disabled = true;
                if (!isInitialized) {
                    submitButtonText.textContent = '初期化中...';
                } else {
                     submitButtonText.textContent = '同意事項にチェックしてください';
                }
            }
        };

        const fetchIpAddress = async () => {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                ipAddressDisplay.textContent = data.ip; // 表示用要素にIPアドレスをセット
                ipAddressHiddenInput.value = data.ip; // 隠し要素にIPアドレスをセット
                return true;
            } catch (error) {
                console.error('IPアドレスの取得に失敗しました:', error);
                ipAddressDisplay.textContent = '取得できませんでした';
                statusMessage.textContent = 'エラー: IPアドレスを取得できませんでした。';
                statusMessage.className = 'text-center text-sm text-yellow-400';
                return false;
            }
        };

        const initializeApplication = async () => {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase設定が見つかりません。");
                submitButtonText.textContent = '設定エラー';
                statusMessage.textContent = 'エラー: アプリケーションの設定が不十分です。';
                statusMessage.className = 'text-center text-sm text-red-500';
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                submitButtonText.textContent = '認証中...';
                const userCredential = initialAuthToken
                    ? await signInWithCustomToken(auth, initialAuthToken)
                    : await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("Authenticated user ID:", userId);

                submitButtonText.textContent = '情報取得中...';
                await fetchIpAddress();

                reportFieldset.disabled = false;
                agreementCheckbox.disabled = false;
                isInitialized = true;
                statusMessage.textContent = '報告の準備ができました。';
                statusMessage.className = 'text-center text-sm text-green-500';

            } catch (error) {
                console.error("アプリケーションの初期化に失敗しました:", error);
                submitButtonText.textContent = '初期化エラー';
                statusMessage.textContent = 'エラー: 初期化に失敗しました。リフレッシュしてください。';
                statusMessage.className = 'text-center text-sm text-red-500';
            } finally {
                updateSubmitButtonState();
            }
        };

        const submitReport = async () => {
            confirmationModal.classList.add('hidden');
            submitButton.disabled = true;
            submitButtonText.textContent = '送信中...';
            statusMessage.textContent = '';

            const reportData = {
                reporterEmail: reportForm.reporterEmail.value,
                reportedUserEmail: reportForm.reportedUserEmail.value,
                category: reportForm.category.value,
                reason: reportForm.reason.value,
                screenshotLink: reportForm.screenshotLink.value || null,
                reporterIpAddress: ipAddressHiddenInput.value, // 隠し要素から値を取得
                agreedToTerms: agreementCheckbox.checked,
                createdAt: serverTimestamp(),
                status: 'new'
            };

            try {
                const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');
                const docRef = await addDoc(reportsCollectionRef, reportData);
                
                console.log("Document written with ID: ", docRef.id);
                statusMessage.textContent = '通報が正常に送信されました。';
                statusMessage.className = 'text-center text-sm text-green-500';
                reportForm.reset();
                agreementCheckbox.checked = false;
                ipAddressDisplay.textContent = reportData.reporterIpAddress; // 表示用要素もリセット
                ipAddressHiddenInput.value = reportData.reporterIpAddress; // 隠し要素もリセット

            } catch (error) {
                console.error("Firestoreへの書き込み中にエラーが発生しました: ", error);
                statusMessage.textContent = 'エラー: 通報を送信できませんでした。';
                statusMessage.className = 'text-center text-sm text-red-500';
            } finally {
                updateSubmitButtonState();
            }
        };

        // --- イベントリスナー ---
        agreementCheckbox.addEventListener('change', updateSubmitButtonState);

        reportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (agreementCheckbox.checked) {
                confirmationModal.classList.remove('hidden');
            }
        });

        confirmReportButton.addEventListener('click', submitReport);

        cancelReportButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                confirmationModal.classList.add('hidden');
            }
        });

        // --- アプリケーションの実行開始 ---
        document.addEventListener('DOMContentLoaded', initializeApplication);

    </script>
</body>
</html>
